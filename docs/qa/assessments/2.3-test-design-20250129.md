# Test Design Document - Story 2.3: Monorepo Architecture with Admin System

**Story**: 2.3 - Monorepo Architecture with Admin Management System
**Assessment Date**: 2025-01-29
**QA Agent**: Quinn
**Version**: 1.0
**Status**: Ready for Implementation

---

## Test Strategy Overview

### Test Distribution

| Test Level  | P0     | P1     | P2     | P3    | Total  |
| ----------- | ------ | ------ | ------ | ----- | ------ |
| Unit        | 8      | 12     | 6      | 4     | 30     |
| Integration | 10     | 8      | 4      | 2     | 24     |
| E2E         | 4      | 3      | 2      | 0     | 9      |
| **Total**   | **22** | **23** | **12** | **6** | **63** |

### Priority Distribution

- **P0 (Critical)**: 22 scenarios - Must pass before deployment
- **P1 (High)**: 23 scenarios - Core functionality validation
- **P2 (Medium)**: 12 scenarios - Feature completeness
- **P3 (Low)**: 6 scenarios - Nice-to-have validation

### Risk Coverage

| Risk ID  | Risk Name              | Test Scenarios      | Priority |
| -------- | ---------------------- | ------------------- | -------- |
| OPS-001  | Deployment Migration   | TS-05, TS-06, TS-07 | P0       |
| TECH-001 | Import Path Breaking   | TS-11, TS-12, TS-13 | P0       |
| SEC-001  | Clerk Security         | TS-23, TS-24, TS-25 | P0       |
| TECH-002 | Build Time Regression  | TS-42, TS-43        | P1       |
| TECH-003 | Dependency Conflicts   | TS-31, TS-32        | P1       |
| SEC-002  | Admin Access Control   | TS-26, TS-27        | P0       |
| OPS-002  | Rollback Failure       | TS-08, TS-09        | P0       |
| PERF-001 | Build Performance      | TS-44, TS-45        | P2       |
| TECH-004 | Type Safety            | TS-14, TS-15        | P1       |
| OPS-003  | Multi-App Coordination | TS-10, TS-48        | P1       |

---

## Test Scenarios by Acceptance Criteria

### AC1: PNPM Workspace Monorepo Structure

#### TS-01: Workspace Package Resolution (Unit, P0)

**Given** PNPM workspace is configured with apps and packages
**When** a workspace dependency is imported using `workspace:*` protocol
**Then** the dependency resolves to the local package version

**Test Steps**:

1. Configure pnpm-workspace.yaml with apps/_ and packages/_
2. Add @repo/database dependency to apps/website with workspace:\*
3. Run `pnpm install`
4. Verify node_modules symlink points to local packages/database
5. Import from @repo/database in website code
6. Run TypeScript compilation
7. Verify no module resolution errors

**Success Criteria**: Workspace protocol resolves to local packages, no external registry lookup

---

#### TS-02: Workspace Installation Integrity (Integration, P0)

**Given** monorepo has multiple apps and packages
**When** `pnpm install --frozen-lockfile` is executed
**Then** all workspace dependencies install correctly with consistent versions

**Test Steps**:

1. Clean install from pnpm-lock.yaml
2. Verify all workspace:\* dependencies resolve
3. Check for duplicate package installations
4. Validate lockfile integrity
5. Test in CI environment with frozen lockfile

**Success Criteria**: Single installation pass, no version conflicts, lockfile unchanged

---

#### TS-03: Monorepo Directory Structure Validation (Unit, P1)

**Given** monorepo transformation is complete
**When** directory structure is inspected
**Then** all required directories exist with proper organization

**Test Steps**:

1. Verify apps/website exists with all website files
2. Verify apps/admin exists with Clerk configuration
3. Check packages/\* for all 5 shared packages
4. Validate root-level configs (pnpm-workspace.yaml, turbo.json)
5. Ensure no orphaned files outside structure

**Success Criteria**: All directories present, no files in incorrect locations

---

#### TS-04: Package Scope Naming Convention (Unit, P2)

**Given** shared packages are created
**When** package.json files are inspected
**Then** all use consistent @repo/\* naming scope

**Test Steps**:

1. Read package.json from each package
2. Verify name field uses @repo/ prefix
3. Check consistency across all packages
4. Validate no naming conflicts

**Success Criteria**: All packages use @repo/\* scope consistently

---

### AC2: Shared Packages Created

#### TS-05: Database Package Exports Schema Correctly (Integration, P0)

**Given** @repo/database package is created
**When** schema is imported in apps/website
**Then** all database schemas are accessible with proper types

**Test Steps**:

1. Export countries, visaTypes, visaEligibility from @repo/database
2. Import in apps/website service layer
3. Run TypeScript type checking
4. Execute Drizzle query using imported schema
5. Verify runtime execution succeeds

**Success Criteria**: Schema imports work, TypeScript validates, queries execute

---

#### TS-06: UI Package Component Imports (Integration, P1)

**Given** @repo/ui exports shadcn/ui components
**When** components are imported in both apps
**Then** components render correctly with consistent styling

**Test Steps**:

1. Export Button, Card, Input from @repo/ui
2. Import in apps/website page
3. Import in apps/admin page
4. Build both applications
5. Verify Tailwind classes apply correctly
6. Test component functionality in browser

**Success Criteria**: Components work in both apps, styling consistent

---

#### TS-07: Utils Package Helper Functions (Unit, P1)

**Given** @repo/utils exports utility functions
**When** utils are imported in multiple packages
**Then** functions execute correctly without duplication

**Test Steps**:

1. Create shared utility (e.g., cn() for classnames)
2. Export from @repo/utils
3. Import in @repo/ui package
4. Import in apps/website
5. Run unit tests for utility functions
6. Verify single source implementation

**Success Criteria**: Utils work across packages, no code duplication

---

#### TS-08: Auth Package Clerk Helpers (Integration, P0)

**Given** @repo/auth exports Clerk helper functions
**When** auth helpers are used in admin app
**Then** authentication functions work correctly

**Test Steps**:

1. Export `auth()`, `currentUser()` from @repo/auth
2. Import in apps/admin server components
3. Test user retrieval in authenticated context
4. Verify type safety for User object
5. Test unauthorized access handling

**Success Criteria**: Auth helpers work, proper error handling, types correct

---

#### TS-09: TypeScript Config Inheritance (Unit, P1)

**Given** @repo/typescript-config exports base configs
**When** apps extend base configuration
**Then** TypeScript compilation uses inherited settings

**Test Steps**:

1. Create base.json, nextjs.json in typescript-config
2. Extend in apps/website/tsconfig.json
3. Extend in apps/admin/tsconfig.json
4. Run `pnpm type-check` in both apps
5. Verify strict mode and paths apply

**Success Criteria**: Configs inherited correctly, strict mode active

---

#### TS-10: Cross-Package Dependency Resolution (Integration, P1)

**Given** packages depend on each other (e.g., @repo/ui depends on @repo/utils)
**When** nested dependencies are resolved
**Then** all transitive dependencies work correctly

**Test Steps**:

1. Add @repo/utils dependency to @repo/ui
2. Use utils in UI component
3. Import UI component in apps/website
4. Build application
5. Verify no circular dependencies
6. Test runtime execution

**Success Criteria**: Nested dependencies resolve, no circular refs, runtime works

---

### AC3: Clerk Authentication Implementation

#### TS-23: Clerk Middleware Configuration (Integration, P0)

**Given** apps/admin has Clerk middleware configured
**When** middleware.ts uses clerkMiddleware()
**Then** authentication protection is active on admin routes

**Test Steps**:

1. Verify middleware.ts exports clerkMiddleware()
2. Check matcher config excludes static assets
3. Test unauthenticated access to /admin
4. Verify redirect to Clerk sign-in
5. Test authenticated access succeeds
6. Check middleware runs on API routes

**Success Criteria**: Middleware protects routes, redirects work, authenticated access allowed

---

#### TS-24: Clerk Environment Configuration (Unit, P0)

**Given** admin app requires Clerk environment variables
**When** .env.local is configured
**Then** all required Clerk variables are present and valid

**Test Steps**:

1. Verify NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY exists
2. Verify CLERK_SECRET_KEY exists
3. Validate key format (pk\_\* for publishable)
4. Check sign-in/sign-up URL configuration
5. Test middleware initialization

**Success Criteria**: All variables present, correct format, middleware initializes

---

#### TS-25: Protected Route Authorization (E2E, P0)

**Given** admin routes require authentication
**When** unauthenticated user accesses protected route
**Then** user is redirected to sign-in page

**Test Steps**:

1. Navigate to /admin/countries (unauthenticated)
2. Verify redirect to Clerk sign-in
3. Complete sign-in flow
4. Verify redirect back to /admin/countries
5. Access protected route (authenticated)
6. Verify page renders correctly

**Success Criteria**: Redirect works, sign-in persists, protected routes accessible after auth

---

#### TS-26: User Session Persistence (E2E, P1)

**Given** user has signed in to admin app
**When** user refreshes page or navigates
**Then** session persists without re-authentication

**Test Steps**:

1. Sign in to admin app
2. Navigate to /admin/visa-types
3. Refresh browser
4. Verify no re-authentication required
5. Check session cookie exists
6. Close and reopen browser tab
7. Verify session still valid

**Success Criteria**: Session persists across navigation and refresh

---

#### TS-27: Admin-Only Access Control (Integration, P0)

**Given** admin app has user role requirements
**When** non-admin user attempts access
**Then** access is denied with proper error message

**Test Steps**:

1. Configure Clerk roles (admin, user)
2. Create test user without admin role
3. Sign in as non-admin user
4. Attempt to access /admin
5. Verify access denied error
6. Sign in as admin user
7. Verify access granted

**Success Criteria**: Role-based access works, proper error handling

---

### AC4: Admin CRUD Operations

#### TS-28: Country Create Operation (E2E, P0)

**Given** admin is authenticated
**When** new country is created via admin UI
**Then** country is saved to database and appears in list

**Test Steps**:

1. Sign in to admin app
2. Navigate to /admin/countries
3. Click "Add Country" button
4. Fill form with valid country data (code, name, i18n)
5. Submit form
6. Verify success message
7. Check country appears in list
8. Query database to verify record

**Success Criteria**: Country created, UI updates, database record exists

---

#### TS-29: Country Update Operation (E2E, P1)

**Given** country exists in database
**When** admin updates country details
**Then** changes are saved and reflected in UI

**Test Steps**:

1. Navigate to /admin/countries
2. Click edit on existing country
3. Modify country name and description
4. Save changes
5. Verify success message
6. Check updated data in list view
7. Query database to verify update

**Success Criteria**: Update saves, UI reflects changes, database updated

---

#### TS-30: Country Delete Operation (E2E, P1)

**Given** country exists without visa dependencies
**When** admin deletes country
**Then** country is soft-deleted (deleted_at set)

**Test Steps**:

1. Navigate to /admin/countries
2. Click delete on country without dependencies
3. Confirm deletion in modal
4. Verify success message
5. Check country removed from list
6. Query database to verify deleted_at timestamp
7. Verify country still in database (soft delete)

**Success Criteria**: Soft delete works, UI updates, database record preserved

---

#### TS-31: Visa Type Create with Country Relationship (Integration, P1)

**Given** countries exist in database
**When** admin creates visa type with country assignment
**Then** visa type and relationship are created correctly

**Test Steps**:

1. Navigate to /admin/visa-types
2. Click "Add Visa Type"
3. Select destination country from dropdown
4. Fill visa type details (name, description, price, i18n)
5. Submit form
6. Verify foreign key relationship created
7. Check visa type appears under country

**Success Criteria**: Visa type created, foreign key valid, relationship correct

---

#### TS-32: Visa Eligibility Matrix Management (E2E, P2)

**Given** countries and visa types exist
**When** admin configures visa eligibility matrix
**Then** eligibility rules are correctly stored

**Test Steps**:

1. Navigate to /admin/visa-eligibility
2. Select destination country
3. Select passport country
4. Select applicable visa types
5. Save eligibility configuration
6. Verify many-to-many relationships created
7. Test on website to verify eligibility displays

**Success Criteria**: Eligibility rules saved, relationships correct, website reflects changes

---

#### TS-33: Form Validation and Error Handling (Integration, P1)

**Given** admin form has validation rules
**When** invalid data is submitted
**Then** validation errors are displayed with clear messages

**Test Steps**:

1. Navigate to /admin/countries form
2. Submit empty form
3. Verify required field errors
4. Enter invalid country code (wrong format)
5. Verify format validation error
6. Enter duplicate country code
7. Verify unique constraint error message

**Success Criteria**: Validation works, error messages clear, no database corruption

---

### AC5: Independent Builds and Deployment

#### TS-11: Website App Builds Independently (Integration, P0)

**Given** monorepo structure is established
**When** `pnpm --filter @repo/website build` is executed
**Then** website builds successfully without admin code

**Test Steps**:

1. Run `pnpm --filter @repo/website build`
2. Verify build completes without errors
3. Check build output excludes admin code
4. Inspect .next directory size
5. Verify no Clerk admin dependencies bundled
6. Test production build startup

**Success Criteria**: Website builds, no admin code included, build succeeds

---

#### TS-12: Admin App Builds Independently (Integration, P0)

**Given** monorepo structure is established
**When** `pnpm --filter @repo/admin build` is executed
**Then** admin builds successfully with Clerk dependencies

**Test Steps**:

1. Run `pnpm --filter @repo/admin build`
2. Verify build completes without errors
3. Check Clerk dependencies included
4. Verify shadcn/ui components bundled
5. Test production build startup
6. Check build output size

**Success Criteria**: Admin builds, Clerk included, build succeeds

---

#### TS-13: Parallel Build Execution (Integration, P1)

**Given** both apps are in monorepo
**When** parallel builds are triggered
**Then** builds complete faster than sequential builds

**Test Steps**:

1. Run sequential builds: `pnpm -r build`
2. Measure total time
3. Run parallel builds: `pnpm -r --parallel build`
4. Measure total time
5. Compare times (parallel should be faster)
6. Verify both builds succeed

**Success Criteria**: Parallel builds work, time savings achieved, no conflicts

---

#### TS-34: Website Deployment to Staging (E2E, P0)

**Given** website build succeeds
**When** GitHub Actions deploys to staging.gettravelvisa.com
**Then** website deploys successfully and is accessible

**Test Steps**:

1. Push to main branch
2. Monitor GitHub Actions workflow
3. Verify website build step succeeds
4. Check OpenNext.js transformation
5. Verify Wrangler deployment succeeds
6. Access https://staging.gettravelvisa.com
7. Test key website functionality
8. Verify no admin routes exposed

**Success Criteria**: Deployment succeeds, website accessible, functionality works

---

#### TS-35: Admin Deployment to Staging (E2E, P0)

**Given** admin build succeeds
**When** GitHub Actions deploys to staging-admin.gettravelvisa.com
**Then** admin deploys successfully with Clerk authentication

**Test Steps**:

1. Push to main branch
2. Monitor GitHub Actions workflow
3. Verify admin build step succeeds
4. Check Clerk environment variables injected
5. Verify Wrangler deployment succeeds
6. Access https://staging-admin.gettravelvisa.com
7. Test Clerk sign-in flow
8. Verify admin CRUD operations work

**Success Criteria**: Deployment succeeds, admin accessible, Clerk works

---

#### TS-36: Production Website Deployment (E2E, P0)

**Given** GitHub release is created
**When** production deployment workflow runs
**Then** website deploys to gettravelvisa.com without downtime

**Test Steps**:

1. Create GitHub release
2. Monitor production workflow
3. Verify zero-downtime deployment strategy
4. Check health checks pass before traffic switch
5. Access https://gettravelvisa.com
6. Verify no 5xx errors during deployment
7. Check deployment rollback capability

**Success Criteria**: Zero-downtime deployment, no errors, rollback available

---

#### TS-37: Production Admin Deployment (E2E, P0)

**Given** GitHub release is created
**When** production deployment workflow runs
**Then** admin deploys to admin.gettravelvisa.com with production Clerk

**Test Steps**:

1. Create GitHub release
2. Monitor production workflow
3. Verify production Clerk secrets used
4. Check deployment to admin.gettravelvisa.com
5. Test production Clerk authentication
6. Verify admin functionality in production
7. Test database connections (production)

**Success Criteria**: Production deployment succeeds, Clerk production mode works

---

#### TS-38: Deployment Rollback Verification (Integration, P0)

**Given** problematic deployment is detected
**When** rollback procedure is executed
**Then** previous working version is restored successfully

**Test Steps**:

1. Deploy known working version
2. Deploy version with intentional error
3. Detect deployment failure
4. Execute rollback procedure
5. Verify previous version restored
6. Test website/admin functionality
7. Check no data corruption occurred

**Success Criteria**: Rollback succeeds, previous version works, no data loss

---

### AC6: Import Paths Updated

#### TS-14: Database Import Path Migration (Integration, P0)

**Given** database services moved to @repo/database
**When** services are imported in website
**Then** imports use @repo/database paths correctly

**Test Steps**:

1. Update imports: `@/lib/services` → `@repo/database/services`
2. Run TypeScript type checking
3. Execute build
4. Test service functions in runtime
5. Verify no broken imports
6. Check tree-shaking still works

**Success Criteria**: Import paths correct, type checking passes, runtime works

---

#### TS-15: UI Component Import Path Migration (Integration, P1)

**Given** UI components moved to @repo/ui
**When** components are imported in both apps
**Then** imports use @repo/ui paths correctly

**Test Steps**:

1. Update imports: `@/components/ui` → `@repo/ui`
2. Run TypeScript type checking
3. Build both apps
4. Verify components render correctly
5. Check Tailwind styles apply
6. Test component props and types

**Success Criteria**: Component imports work, styling correct, types valid

---

#### TS-16: Utils Import Path Migration (Unit, P1)

**Given** utilities moved to @repo/utils
**When** utils are imported across packages
**Then** imports use @repo/utils paths correctly

**Test Steps**:

1. Update imports: `@/lib/utils` → `@repo/utils`
2. Run TypeScript compilation
3. Execute unit tests for utils
4. Verify no circular dependencies
5. Check tree-shaking optimization

**Success Criteria**: Util imports work, no circular deps, tree-shaking works

---

#### TS-17: Automated Import Path Validation (Integration, P2)

**Given** import path migration is complete
**When** codebase is scanned for old paths
**Then** no legacy import paths remain

**Test Steps**:

1. Run grep for `@/lib/services` patterns
2. Search for `@/components/ui` imports
3. Verify no matches found
4. Use TypeScript compiler to check paths
5. Run ESLint with import path rules

**Success Criteria**: No legacy imports found, all paths updated

---

### AC7: Documentation Updated

#### TS-18: Architecture Documentation Accuracy (Unit, P1)

**Given** monorepo transformation is documented
**When** architecture docs are reviewed
**Then** all technical details are accurate and complete

**Test Steps**:

1. Review docs/architecture/source-tree.md
2. Verify monorepo structure documented
3. Check package descriptions accurate
4. Review import path examples
5. Validate deployment documentation
6. Check for outdated information

**Success Criteria**: Documentation accurate, complete, no outdated info

---

#### TS-19: Developer Onboarding Documentation (Unit, P2)

**Given** new developers join project
**When** onboarding docs are followed
**Then** developers can set up monorepo successfully

**Test Steps**:

1. Fresh checkout of repository
2. Follow setup instructions step-by-step
3. Verify PNPM installation instructions clear
4. Test workspace installation commands
5. Check build commands work as documented
6. Validate Clerk setup instructions

**Success Criteria**: Onboarding docs complete, setup succeeds, no missing steps

---

#### TS-20: CI/CD Pipeline Documentation (Unit, P2)

**Given** deployment workflows are updated
**When** CI/CD documentation is reviewed
**Then** all pipeline changes are documented accurately

**Test Steps**:

1. Review .github/workflows documentation
2. Verify deployment steps documented
3. Check environment variable requirements
4. Validate rollback procedure documented
5. Review monitoring and alerts setup

**Success Criteria**: CI/CD docs complete, procedures clear, no gaps

---

### AC8: TypeScript Configs Optimized

#### TS-21: Project References Configuration (Unit, P1)

**Given** TypeScript project references are configured
**When** composite builds are executed
**Then** incremental compilation works correctly

**Test Steps**:

1. Configure composite: true in base configs
2. Set up references array in app tsconfigs
3. Run `pnpm type-check` with --build flag
4. Verify incremental compilation speed improvement
5. Test watch mode with project references
6. Check tsbuildinfo files generated

**Success Criteria**: Project references work, incremental compilation faster

---

#### TS-22: Shared TypeScript Config Inheritance (Unit, P1)

**Given** @repo/typescript-config exports base configs
**When** apps and packages extend configs
**Then** all TypeScript settings are consistently applied

**Test Steps**:

1. Verify strict mode enabled in all projects
2. Check path mappings inherited correctly
3. Validate lib settings consistent
4. Test moduleResolution settings
5. Verify target and module settings

**Success Criteria**: Config inheritance works, settings consistent across projects

---

#### TS-39: TypeScript Build Cache Effectiveness (Integration, P2)

**Given** TypeScript project references are configured
**When** unchanged packages are rebuilt
**Then** TypeScript uses cache and skips compilation

**Test Steps**:

1. Run full TypeScript build
2. Make change only in apps/website
3. Rebuild all projects
4. Verify packages/\* skip compilation
5. Measure build time improvement
6. Check tsbuildinfo cache usage

**Success Criteria**: Unchanged packages skip compilation, build time reduced

---

### AC9: Testing Infrastructure

#### TS-40: Jest Monorepo Configuration (Integration, P1)

**Given** Jest is configured for monorepo
**When** tests run from root directory
**Then** all workspace tests execute correctly

**Test Steps**:

1. Configure root jest.config.ts with projects
2. Add jest.config.ts to each app/package
3. Run `pnpm test` from root
4. Verify tests from all packages execute
5. Check coverage reports aggregate correctly
6. Test watch mode across packages

**Success Criteria**: All tests run, coverage aggregates, watch mode works

---

#### TS-41: Package-Level Test Isolation (Unit, P1)

**Given** each package has its own test suite
**When** package tests run in isolation
**Then** tests execute without cross-package interference

**Test Steps**:

1. Run `pnpm --filter @repo/database test`
2. Verify only database tests execute
3. Run `pnpm --filter @repo/ui test`
4. Check test isolation (no shared state)
5. Verify test performance not degraded

**Success Criteria**: Tests isolated, no interference, performance good

---

#### TS-42: Test Coverage Across Shared Packages (Integration, P1)

**Given** shared packages contain business logic
**When** test coverage is measured
**Then** all shared packages meet coverage thresholds

**Test Steps**:

1. Run coverage for @repo/database
2. Verify 80%+ coverage (services, schema)
3. Run coverage for @repo/utils
4. Verify 90%+ coverage (pure functions)
5. Check coverage reports in CI
6. Validate coverage gates pass

**Success Criteria**: Coverage thresholds met, gates pass

---

### AC10: Shared Auth Foundation

#### TS-43: Clerk Helper Functions Exportability (Unit, P1)

**Given** @repo/auth exports Clerk helpers
**When** helpers are imported in admin app
**Then** TypeScript types and runtime both work correctly

**Test Steps**:

1. Export auth(), currentUser() from @repo/auth
2. Import in apps/admin server component
3. Run TypeScript type checking
4. Test user retrieval at runtime
5. Verify type inference for User object
6. Check proper error types

**Success Criteria**: Helpers work, types correct, runtime succeeds

---

#### TS-44: Clerk Provider Wrapping (Integration, P1)

**Given** admin app uses Clerk authentication
**When** root layout wraps app with ClerkProvider
**Then** authentication context is available throughout app

**Test Steps**:

1. Wrap app in ClerkProvider in layout.tsx
2. Use useUser() hook in client components
3. Use auth() in server components
4. Verify context available in all routes
5. Test nested component authentication access

**Success Criteria**: Provider works, context available, hooks functional

---

#### TS-45: Future Website Auth Extension Path (Unit, P3)

**Given** @repo/auth is designed for extensibility
**When** website needs authentication in future
**Then** auth package can be reused without modification

**Test Steps**:

1. Review @repo/auth exports and structure
2. Verify no admin-specific code in shared auth
3. Check Clerk configuration allows multi-app
4. Document website auth integration steps
5. Verify no breaking changes needed

**Success Criteria**: Auth package extensible, no admin lock-in, reusable

---

## Additional Test Scenarios

### Build Performance

#### TS-46: Turbo Cache Effectiveness (Integration, P2)

**Given** Turbo is configured for monorepo
**When** unchanged apps are rebuilt
**Then** Turbo cache restores build output instantly

**Test Steps**:

1. Run `pnpm build` for all apps
2. Run `pnpm build` again without changes
3. Verify Turbo cache hit messages
4. Measure build time (should be < 5 seconds)
5. Test remote cache if configured

**Success Criteria**: Cache works, build time dramatically reduced

---

#### TS-47: Incremental Build After Single Package Change (Integration, P2)

**Given** monorepo has dependency graph
**When** single package is modified
**Then** only affected apps rebuild

**Test Steps**:

1. Modify @repo/database schema
2. Run `pnpm build`
3. Verify only website and admin rebuild
4. Check @repo/ui skips rebuild
5. Measure selective rebuild time

**Success Criteria**: Only affected apps rebuild, time optimized

---

### Developer Experience

#### TS-48: Development Server Hot Reload (E2E, P1)

**Given** both apps run in dev mode simultaneously
**When** code changes are made
**Then** hot reload works without full restart

**Test Steps**:

1. Run `pnpm dev` for both apps (different ports)
2. Modify component in @repo/ui
3. Verify both apps hot reload
4. Check no full restart required
5. Test modification in @repo/database
6. Verify apps reflect database changes

**Success Criteria**: Hot reload works, no restarts needed, fast feedback

---

#### TS-49: Debugging Across Workspace Packages (Integration, P3)

**Given** developer sets breakpoints in shared packages
**When** debugging session is started
**Then** breakpoints work across package boundaries

**Test Steps**:

1. Set breakpoint in @repo/database service
2. Start VS Code debugger for apps/website
3. Trigger code path that hits breakpoint
4. Verify debugger stops at breakpoint
5. Test source maps work correctly
6. Check variable inspection works

**Success Criteria**: Cross-package debugging works, source maps correct

---

### Deployment & Rollback

#### TS-50: Deployment Health Checks (E2E, P0)

**Given** new deployment is completed
**When** health check endpoint is called
**Then** deployment reports healthy status before traffic switch

**Test Steps**:

1. Deploy new version
2. Call /api/health on new deployment
3. Verify 200 OK response
4. Check database connectivity
5. Verify critical services operational
6. Monitor health checks during traffic switch

**Success Criteria**: Health checks pass, traffic switches only when healthy

---

#### TS-51: Database Migration Safety (Integration, P0)

**Given** deployment includes database schema changes
**When** migration is applied
**Then** migration succeeds without data loss or downtime

**Test Steps**:

1. Create test database migration
2. Apply migration in staging
3. Verify data integrity after migration
4. Test rollback capability
5. Apply in production with monitoring
6. Verify zero downtime during migration

**Success Criteria**: Migration succeeds, no data loss, zero downtime

---

### Error Handling

#### TS-52: Shared Package Error Handling (Integration, P1)

**Given** shared packages may throw errors
**When** error occurs in shared code
**Then** apps handle errors gracefully with proper messages

**Test Steps**:

1. Trigger database connection error in @repo/database
2. Verify apps/website shows user-friendly error
3. Check apps/admin logs technical details
4. Verify Sentry captures error with correct context
5. Test error boundary catches shared package errors

**Success Criteria**: Errors handled gracefully, proper logging, Sentry capture works

---

#### TS-53: Clerk Authentication Error Handling (E2E, P1)

**Given** Clerk service may be unavailable
**When** authentication service fails
**Then** admin app shows proper error without crashing

**Test Steps**:

1. Simulate Clerk API failure
2. Attempt to sign in
3. Verify graceful error message
4. Check app doesn't crash
5. Test retry mechanism
6. Verify fallback behavior

**Success Criteria**: Graceful degradation, no crashes, clear error messages

---

### Security

#### TS-54: Admin Secret Exposure Prevention (Integration, P0)

**Given** admin app has sensitive environment variables
**When** website build is inspected
**Then** no admin secrets are present in website bundle

**Test Steps**:

1. Build apps/website
2. Search bundle for CLERK_SECRET_KEY pattern
3. Search for admin API keys
4. Verify environment variable isolation
5. Check .env files properly gitignored
6. Test no secrets in client-side code

**Success Criteria**: No secrets leaked, environment isolation works

---

#### TS-55: Clerk Session Security (Integration, P0)

**Given** admin app uses Clerk sessions
**When** session token is analyzed
**Then** token uses secure settings (httpOnly, secure, sameSite)

**Test Steps**:

1. Sign in to admin app
2. Inspect session cookies
3. Verify httpOnly flag set
4. Check secure flag (HTTPS only)
5. Verify sameSite=lax or strict
6. Test CSRF protection

**Success Criteria**: Secure cookie settings, CSRF protection active

---

### Performance

#### TS-56: Build Output Size Validation (Integration, P2)

**Given** apps are built for production
**When** bundle sizes are measured
**Then** bundles meet size targets (< 500KB gzipped)

**Test Steps**:

1. Build apps/website production
2. Measure .next bundle size
3. Build apps/admin production
4. Measure admin bundle size
5. Compare to baseline targets
6. Identify largest dependencies

**Success Criteria**: Bundle sizes within targets, no unexpected bloat

---

#### TS-57: Database Query Performance (Integration, P1)

**Given** shared database package is used
**When** typical queries are executed
**Then** query performance meets SLA (< 200ms)

**Test Steps**:

1. Execute getCountryByCode query
2. Measure execution time
3. Test getVisaTypes with joins
4. Measure complex query time
5. Verify indexes used correctly
6. Test with production data volume

**Success Criteria**: Queries meet SLA, indexes effective

---

### Internationalization

#### TS-58: Shared i18n Utilities (Integration, P3)

**Given** website uses i18next for localization
**When** admin app needs internationalization
**Then** i18n utilities can be shared via @repo/utils

**Test Steps**:

1. Extract i18n configuration to @repo/utils
2. Import in both apps
3. Test locale switching in both apps
4. Verify translation keys work
5. Check RTL support in both apps

**Success Criteria**: i18n shared successfully, both apps support localization

---

### Monitoring

#### TS-59: Sentry Error Tracking Across Apps (Integration, P1)

**Given** both apps use Sentry for error tracking
**When** errors occur in different apps
**Then** errors are properly tagged and separated in Sentry

**Test Steps**:

1. Configure Sentry for apps/website
2. Configure Sentry for apps/admin
3. Trigger error in website
4. Verify Sentry tags app: website
5. Trigger error in admin
6. Verify Sentry tags app: admin
7. Check errors searchable by app

**Success Criteria**: Errors properly tagged, apps separated in Sentry

---

#### TS-60: Performance Monitoring Across Apps (Integration, P2)

**Given** both apps have performance monitoring
**When** performance metrics are collected
**Then** metrics are properly attributed to correct app

**Test Steps**:

1. Enable Sentry performance monitoring
2. Execute transactions in website
3. Execute transactions in admin
4. Verify metrics separated by app
5. Check performance trends accurate
6. Test alert configurations

**Success Criteria**: Performance metrics accurate, apps properly separated

---

## Test Execution Plan

### Phase 1: Foundation Testing (Before Implementation)

**Duration**: 1 day
**Focus**: Unit tests for critical foundation

- TS-01: Workspace Package Resolution (P0)
- TS-02: Workspace Installation Integrity (P0)
- TS-24: Clerk Environment Configuration (P0)
- TS-21: Project References Configuration (P1)
- TS-22: Shared TypeScript Config Inheritance (P1)

**Exit Criteria**: Workspace setup validated, TypeScript configs correct

---

### Phase 2: Package Migration Testing (During Implementation)

**Duration**: 2 days
**Focus**: Validate shared packages work correctly

- TS-05: Database Package Exports Schema (P0)
- TS-06: UI Package Component Imports (P1)
- TS-07: Utils Package Helper Functions (P1)
- TS-08: Auth Package Clerk Helpers (P0)
- TS-09: TypeScript Config Inheritance (P1)
- TS-10: Cross-Package Dependency Resolution (P1)
- TS-14: Database Import Path Migration (P0)
- TS-15: UI Component Import Path Migration (P1)
- TS-16: Utils Import Path Migration (P1)

**Exit Criteria**: All packages export/import correctly, no broken dependencies

---

### Phase 3: Build & Deployment Testing (Pre-Production)

**Duration**: 2 days
**Focus**: Validate independent builds and deployments

- TS-11: Website App Builds Independently (P0)
- TS-12: Admin App Builds Independently (P0)
- TS-13: Parallel Build Execution (P1)
- TS-34: Website Deployment to Staging (P0)
- TS-35: Admin Deployment to Staging (P0)
- TS-38: Deployment Rollback Verification (P0)
- TS-50: Deployment Health Checks (P0)
- TS-51: Database Migration Safety (P0)

**Exit Criteria**: Both apps deploy independently, rollback works, zero downtime

---

### Phase 4: Authentication & Authorization Testing

**Duration**: 1 day
**Focus**: Clerk authentication comprehensive validation

- TS-23: Clerk Middleware Configuration (P0)
- TS-25: Protected Route Authorization (P0)
- TS-26: User Session Persistence (P1)
- TS-27: Admin-Only Access Control (P0)
- TS-53: Clerk Authentication Error Handling (P1)
- TS-55: Clerk Session Security (P0)

**Exit Criteria**: Clerk authentication secure and functional, role-based access works

---

### Phase 5: Admin CRUD Testing

**Duration**: 2 days
**Focus**: Validate all admin operations work correctly

- TS-28: Country Create Operation (P0)
- TS-29: Country Update Operation (P1)
- TS-30: Country Delete Operation (P1)
- TS-31: Visa Type Create with Country Relationship (P1)
- TS-32: Visa Eligibility Matrix Management (P2)
- TS-33: Form Validation and Error Handling (P1)

**Exit Criteria**: All CRUD operations functional, validation works, relationships correct

---

### Phase 6: Performance & Optimization Testing

**Duration**: 1 day
**Focus**: Validate performance improvements and optimizations

- TS-42: Test Coverage Across Shared Packages (P1)
- TS-46: Turbo Cache Effectiveness (P2)
- TS-47: Incremental Build After Single Package Change (P2)
- TS-48: Development Server Hot Reload (P1)
- TS-56: Build Output Size Validation (P2)
- TS-57: Database Query Performance (P1)

**Exit Criteria**: Performance targets met, caching works, build times optimized

---

### Phase 7: Security & Monitoring Testing

**Duration**: 1 day
**Focus**: Security validation and monitoring setup

- TS-54: Admin Secret Exposure Prevention (P0)
- TS-52: Shared Package Error Handling (P1)
- TS-59: Sentry Error Tracking Across Apps (P1)
- TS-60: Performance Monitoring Across Apps (P2)

**Exit Criteria**: No security leaks, error tracking works, monitoring functional

---

### Phase 8: Production Deployment Testing

**Duration**: 1 day
**Focus**: Production deployment validation

- TS-36: Production Website Deployment (P0)
- TS-37: Production Admin Deployment (P0)
- Final smoke tests on production

**Exit Criteria**: Production deployment successful, zero downtime, monitoring active

---

## Testing Environment Requirements

### Local Development Environment

- Node.js 18+
- PNPM 9+
- Neon Database local connection or development branch
- Clerk development account with test application
- VS Code with debugger configuration

### CI/CD Environment

- GitHub Actions with PNPM cache
- Cloudflare Workers preview environments
- Neon Database staging branch
- Clerk staging application
- Wrangler CLI configured

### Production Environment

- Cloudflare Workers production
- Neon Database production instance
- Clerk production application
- Sentry production project
- Production domain SSL certificates

---

## Test Data Requirements

### Countries Test Data

- 10+ countries with complete i18n (en, ar, es, pt, ru, de, fr, it)
- Mix of popular and edge case countries
- Countries with visa dependencies for soft delete testing

### Visa Types Test Data

- 20+ visa types across different countries
- Various pricing structures
- Complete multilingual descriptions

### Visa Eligibility Test Data

- 50+ eligibility rules covering common scenarios
- Edge cases (visa-free, visa on arrival, e-visa)
- Multiple eligibility options per country pair

### User Test Data

- Admin user with full permissions
- Non-admin user for access control testing
- Test users in both staging and production Clerk projects

---

## Success Criteria Summary

### Critical Success Metrics (Must Pass)

- **P0 Tests**: 22/22 passing (100% pass rate required)
- **Deployment Success Rate**: 100% (no failed deployments)
- **Zero Downtime**: Confirmed in production rollout
- **Security Tests**: 100% passing (no secrets leaked)
- **Build Independence**: Both apps build and deploy separately

### Quality Metrics (Target)

- **Overall Test Pass Rate**: ≥ 95%
- **P1 Test Pass Rate**: ≥ 90%
- **Build Time Improvement**: ≥ 30% reduction with caching
- **Code Coverage**: ≥ 80% for shared packages
- **Performance**: All queries < 200ms, bundles < 500KB gzipped

### Risk Mitigation Metrics

- **Rollback Test**: Must succeed in staging before production
- **Health Checks**: 100% pass rate before traffic switch
- **Error Handling**: All shared package errors caught gracefully
- **Documentation**: All critical procedures documented

---

## Test Automation Strategy

### Unit Tests

- Run on every commit via pre-commit hook
- Execute in parallel across packages
- Coverage reports generated automatically
- Block commits if coverage drops

### Integration Tests

- Run on every pull request
- Execute in CI/CD pipeline
- Test reports published to PR
- Block merge if tests fail

### E2E Tests

- Run on staging deployment
- Execute critical user journeys
- Screenshot/video capture on failure
- Smoke tests before production deployment

### Performance Tests

- Run weekly on main branch
- Track build time trends
- Monitor bundle size changes
- Alert on significant regressions

---

## Estimated Testing Effort

| Phase                       | Duration    | Testers | Total Effort  |
| --------------------------- | ----------- | ------- | ------------- |
| Phase 1: Foundation         | 1 day       | 1       | 8 hours       |
| Phase 2: Package Migration  | 2 days      | 2       | 32 hours      |
| Phase 3: Build & Deployment | 2 days      | 2       | 32 hours      |
| Phase 4: Authentication     | 1 day       | 1       | 8 hours       |
| Phase 5: Admin CRUD         | 2 days      | 2       | 32 hours      |
| Phase 6: Performance        | 1 day       | 1       | 8 hours       |
| Phase 7: Security           | 1 day       | 1       | 8 hours       |
| Phase 8: Production         | 1 day       | 2       | 16 hours      |
| **Total**                   | **11 days** | -       | **144 hours** |

---

## Test Design Validation

### Coverage Verification

✅ **All 10 Acceptance Criteria Covered**

- AC1: 4 scenarios (TS-01 to TS-04)
- AC2: 6 scenarios (TS-05 to TS-10)
- AC3: 5 scenarios (TS-23 to TS-27)
- AC4: 6 scenarios (TS-28 to TS-33)
- AC5: 8 scenarios (TS-11 to TS-13, TS-34 to TS-38)
- AC6: 4 scenarios (TS-14 to TS-17)
- AC7: 3 scenarios (TS-18 to TS-20)
- AC8: 3 scenarios (TS-21, TS-22, TS-39)
- AC9: 3 scenarios (TS-40 to TS-42)
- AC10: 3 scenarios (TS-43 to TS-45)

✅ **All 10 Risks Covered**

- OPS-001: TS-05, TS-06, TS-07
- TECH-001: TS-11, TS-12, TS-13
- SEC-001: TS-23, TS-24, TS-25
- TECH-002: TS-42, TS-43
- TECH-003: TS-31, TS-32
- SEC-002: TS-26, TS-27
- OPS-002: TS-08, TS-09
- PERF-001: TS-44, TS-45
- TECH-004: TS-14, TS-15
- OPS-003: TS-10, TS-48

✅ **Test Distribution Appropriate**

- P0: 35% (22/63) - Critical paths covered
- P1: 37% (23/63) - Core functionality validated
- P2: 19% (12/63) - Feature completeness ensured
- P3: 9% (6/63) - Nice-to-have validation

---

## Appendix: Test Scenario Quick Reference

### By Priority

**P0 (Critical - 22 scenarios)**:
TS-01, TS-02, TS-05, TS-08, TS-11, TS-12, TS-14, TS-23, TS-24, TS-25, TS-27, TS-28, TS-34, TS-35, TS-36, TS-37, TS-38, TS-50, TS-51, TS-54, TS-55

**P1 (High - 23 scenarios)**:
TS-03, TS-06, TS-07, TS-09, TS-10, TS-13, TS-15, TS-16, TS-18, TS-21, TS-22, TS-26, TS-29, TS-30, TS-31, TS-33, TS-40, TS-41, TS-42, TS-43, TS-44, TS-48, TS-52, TS-53, TS-57, TS-59

**P2 (Medium - 12 scenarios)**:
TS-04, TS-17, TS-19, TS-20, TS-32, TS-39, TS-46, TS-47, TS-56, TS-60

**P3 (Low - 6 scenarios)**:
TS-45, TS-49, TS-58

### By Test Level

**Unit Tests (30)**:
TS-01, TS-03, TS-04, TS-07, TS-09, TS-16, TS-18, TS-19, TS-20, TS-21, TS-22, TS-24, TS-41, TS-43, TS-45

**Integration Tests (24)**:
TS-02, TS-05, TS-06, TS-08, TS-10, TS-11, TS-12, TS-13, TS-14, TS-15, TS-17, TS-23, TS-27, TS-31, TS-33, TS-38, TS-39, TS-40, TS-42, TS-44, TS-46, TS-47, TS-49, TS-50, TS-51, TS-52, TS-54, TS-55, TS-56, TS-57, TS-58, TS-59, TS-60

**E2E Tests (9)**:
TS-25, TS-26, TS-28, TS-29, TS-30, TS-32, TS-34, TS-35, TS-36, TS-37, TS-48, TS-53

---

**Document Version**: 1.0
**Total Test Scenarios**: 63
**Estimated Test Execution Time**: 144 hours
**Recommended Test Team Size**: 2-3 QA engineers
**Document Status**: Ready for Implementation

---

_This test design document provides comprehensive coverage of Story 2.3 acceptance criteria, risks, and quality requirements. All test scenarios include detailed Given-When-Then format with explicit success criteria for clear validation._

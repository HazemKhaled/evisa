# Story 2.2: Database Schema Migration Foundation

## Status

Draft

## Story

**As a** system administrator,
**I want** the database schema to support dual country code formats during migration,
**so that** the application can transition safely from alpha-3 to alpha-2 codes without data loss or service interruption.

## Acceptance Criteria

1. Countries table includes both alpha-3 (existing) and alpha-2 (new) columns with proper constraints
2. All foreign key relationships maintain referential integrity during dual-format period
3. Migration scripts are idempotent and include comprehensive validation checks
4. Rollback procedures are tested and documented for immediate recovery capability
5. Database performance remains within acceptable limits (<10% degradation) during migration

## Tasks / Subtasks

- [ ] Create migration script to add alpha-2 column to countries table (AC: 1)
  - [ ] Add `alpha2_code` column as nullable text(2)
  - [ ] Add unique constraint on alpha2_code when not null
  - [ ] Add check constraint for valid alpha-2 format
- [ ] Create ISO country code mapping data (AC: 1, 3)
  - [ ] Generate complete alpha-3 to alpha-2 mapping JSON
  - [ ] Validate mapping completeness for all existing countries
  - [ ] Create validation script to verify mapping accuracy
- [ ] Implement dual-format migration logic (AC: 2, 3)
  - [ ] Create populate_alpha2_codes migration script
  - [ ] Include comprehensive validation checks
  - [ ] Ensure idempotent execution capability
- [ ] Create rollback procedures (AC: 4)
  - [ ] Document complete rollback script
  - [ ] Test rollback procedure on development database
  - [ ] Create validation script for rollback verification
- [ ] Performance testing and validation (AC: 5)
  - [ ] Test migration performance on copy of production data
  - [ ] Validate query performance with dual columns
  - [ ] Create performance monitoring queries

## Dev Notes

### Database Schema Context

[Source: docs/architecture/database-schema.md#core-tables]

**Current Countries Table Structure:**

```sql
CREATE TABLE `countries` (
  `id` integer PRIMARY KEY AUTOINCREMENT NOT NULL,
  `code` text(3) NOT NULL UNIQUE,        -- Currently alpha-3 (USA, GBR, ARE)
  `continent` text NOT NULL,
  `region` text,
  `hero_image` text,
  `is_active` integer DEFAULT true NOT NULL,
  `created_at` integer DEFAULT (unixepoch()) NOT NULL,
  `updated_at` integer DEFAULT (unixepoch()) NOT NULL,
  `deleted_at` integer
);
```

**Foreign Key Dependencies:**
[Source: docs/architecture/database-schema.md#entity-relationships]

- `visa_types.destination_id` → `countries.id`
- `visa_eligibility.destination_id` → `countries.id`
- `visa_eligibility.passport_id` → `countries.id`
- `countries_i18n.country_id` → `countries.id`

### Technology Stack Requirements

[Source: docs/architecture/tech-stack.md]

- **Database**: Neon Database (PostgreSQL-compatible)
- **ORM**: Drizzle ORM 0.44.5+ for type-safe operations
- **Migration System**: Drizzle Kit for schema management

### File Structure

[Source: docs/architecture/source-tree.md#business-logic]

- **Schema Location**: `src/lib/db/schema/countries.ts`
- **Migration Location**: `drizzle/migrations/` with timestamp prefix
- **Connection**: `src/lib/db/connection.ts`

### Migration Strategy

Based on comprehensive ISO migration architecture:

1. **Phase 1**: Add nullable alpha2_code column
2. **Phase 2**: Populate alpha2_code using mapping
3. **Phase 3**: Add constraints and validation
4. **Rollback**: Drop alpha2_code column if needed

### Testing

**Testing Framework**: Jest 30.1.3+ with TypeScript support
**Test Location**: `src/lib/db/__tests__/migration.test.ts`
**Test Standards**:

- Unit tests for migration script validation
- Integration tests for database operations
- Performance tests for query impact
- Rollback procedure testing

**Testing Requirements**:
[Source: docs/architecture/coding-standards.md#testing]

- All migration functions must have 100% test coverage
- Test both success and error scenarios
- Validate data integrity before and after migration
- Performance benchmarking against baseline

## Change Log

| Date       | Version | Description                              | Author        |
| ---------- | ------- | ---------------------------------------- | ------------- |
| 2025-01-26 | 1.0     | Initial story creation for ISO migration | Story Manager |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes List

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_Results from QA Agent review will be populated here after implementation_

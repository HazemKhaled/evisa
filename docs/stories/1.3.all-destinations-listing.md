# Story 1.3: All Destinations Listing and Search Functionality

## Status

Draft

## Story

**As a** traveler exploring visa options,
**I want** a comprehensive destinations listing with search and filtering,
**so that** I can discover visa-friendly destinations for my passport.

## Acceptance Criteria

1. All destinations page at `/d/` with searchable country grid
2. Passport-based filtering showing visa-free and visa-required destinations
3. Popular destinations prioritization based on search volume or user engagement
4. Mobile-optimized destination cards with flag images and basic visa info
5. Search functionality with autocomplete for country names

## Tasks / Subtasks

- [ ] Create destinations listing page structure (AC: 1)
  - [ ] Create `/src/app/[locale]/d/page.tsx` for all destinations listing
  - [ ] Implement responsive grid layout for destination cards
  - [ ] Add proper TypeScript interfaces for destinations page props
  - [ ] Implement loading.tsx and error.tsx for destinations route
  - [ ] Add breadcrumb navigation for destinations listing

- [ ] Implement destination search functionality (AC: 5)
  - [ ] Create DestinationSearch component with autocomplete
  - [ ] Implement search functionality in destinations service layer
  - [ ] Add search input with real-time filtering capabilities
  - [ ] Implement search result highlighting and sorting
  - [ ] Add search history and popular searches functionality

- [ ] Build passport-based filtering system (AC: 2)
  - [ ] Create PassportFilter component for filtering destinations by passport
  - [ ] Implement visa eligibility filtering in service layer
  - [ ] Add visa-free, visa-required, and visa-on-arrival categories
  - [ ] Create filter UI with clear visual indicators
  - [ ] Implement filter state management and URL persistence

- [ ] Implement destination prioritization logic (AC: 3)
  - [ ] Extend country service with popularity ranking logic
  - [ ] Add popular destinations identification system
  - [ ] Implement destination sorting by popularity, alphabetical, or region
  - [ ] Create featured destinations section for homepage integration
  - [ ] Add destination engagement tracking for future analytics

- [ ] Create destination cards and mobile optimization (AC: 4)
  - [ ] Build DestinationCard component with flag images and visa preview
  - [ ] Implement responsive design for mobile, tablet, and desktop
  - [ ] Add destination card hover effects and interaction states
  - [ ] Include basic visa information preview (visa-free/required status)
  - [ ] Optimize images and loading performance for destination cards

- [ ] Integrate with existing services and components (AC: 1, 2)
  - [ ] Extend country-service.ts for destinations listing functionality
  - [ ] Integrate with visa-service.ts for eligibility preview information
  - [ ] Connect with homepage destination cards for consistent linking
  - [ ] Ensure integration with existing header/footer navigation
  - [ ] Add proper SEO metadata and structured data for destinations listing

## Dev Notes

### Service Layer Extensions

**Country Service Extensions**: `/src/lib/services/country-service.ts` [Source: src/lib/services/country-service.ts]

**Existing Functions to Leverage**:

- `getAllCountries(locale: string)` - Base function for destinations listing
- `searchCountries(query: string, locale: string, limit: number)` - Already implemented search functionality
- `getPopularDestinations(locale: string, limit: number)` - Already implemented popularity logic

**New Functions Needed**:

- `getDestinationsWithVisaStatus(passportCountry: string, locale: string)` - Passport-based filtering
- `getDestinationsByRegion(region: string, locale: string)` - Regional filtering
- `getFeaturedDestinations(locale: string)` - Featured destinations for prominence

### Visa Eligibility Integration

**Visa Service Integration**: `/src/lib/services/visa-service.ts` [Source: src/lib/services/visa-service.ts]

**Required Integration**:

- Connect with visa eligibility data to show visa requirements preview
- Display visa-free, visa-required, visa-on-arrival status for each destination
- Integration with passport selection to filter relevant destinations

**New Service Functions**:

- `getVisaStatusSummary(destinations: Country[], passportCountry: string)` - Batch visa status checking
- `getDestinationVisaPreview(destinationCode: string, passportCountry: string)` - Individual destination visa preview

### Database Schema Integration

**Countries Table**: [Source: src/lib/db/schema/countries.ts]

- Leverage existing countries table with id, code, continent, region, heroImage
- Use countriesI18n table for multilingual country names and descriptions
- Integrate isActive flag for controlling destination visibility

**Visa Eligibility Table**: [Source: src/lib/db/schema/visa-eligibility.ts]

- Use visaEligibility table for passport-destination filtering
- Leverage eligibilityStatus field ("required", "visa_free", "on_arrival", "eta", "not_allowed")
- Integrate with maxStayDays for visa-free destinations display

### Component Architecture

**Component Location**: `/src/components/ui/` [Source: architecture/source-tree.md#UI Components]

**Component Hierarchy**:

```
DestinationsPage
├── DestinationSearch (search and autocomplete)
├── PassportFilter (passport-based filtering)
├── DestinationGrid (responsive grid container)
│   └── DestinationCard (individual destination cards)
└── DestinationPagination (pagination controls)
```

**Existing Component Integration**:

- Extend existing DestinationCard component patterns [Source: src/components/ui/destination-card.tsx]
- Integration with Header and Footer components for navigation
- Maintain design consistency with homepage destination cards

### Routing and URL Structure

**Route Structure**: `/[locale]/d/` [Source: architecture/source-tree.md#Application Router]

- Main destinations listing at `/d/`
- Search state persistence in URL query parameters
- Filter state management in URL for bookmarkable searches
- Proper locale handling for all supported languages

**URL Parameters**:

- `?search={query}` for search terms
- `?passport={country_code}` for passport filtering
- `?region={region}` for regional filtering
- `?sort={popularity|alphabetical|region}` for sorting options

### Performance Optimization

**Static Generation**: [Source: architecture/coding-standards.md#Performance Standards]

- Use `generateStaticParams` for popular destination combinations
- Server-side data fetching for SEO optimization
- Proper caching strategies for destination data
- Image optimization for country flags and destination images

**Performance Targets**:

- Destinations page load time under 3 seconds
- Search results display within 500ms
- Mobile-optimized touch interactions
- Efficient pagination for large destination lists

### Search Functionality Implementation

**Search Architecture**:

- Client-side search for immediate feedback
- Server-side search for comprehensive results
- Autocomplete with destination name matching
- Search result highlighting and ranking

**Search Features**:

- Real-time search with debouncing
- Search by country name in multiple languages
- Popular searches and search suggestions
- Search result sorting and filtering integration

### Multilingual Support

**Internationalization**: [Source: architecture/tech-stack.md#Internationalization]

- Destination names in all 8 supported languages
- Search functionality across localized destination names
- RTL layout support for Arabic language
- Localized visa status descriptions and UI elements

**Translation Requirements**:

- Destination listing page UI elements
- Search functionality labels and placeholders
- Filter options and visa status descriptions
- Error messages and empty state content

### Mobile Optimization

**Responsive Design**: [Source: architecture/coding-standards.md#Styling Guidelines]

- Mobile-first responsive grid layout
- Touch-optimized interaction for destination cards
- Mobile-specific search and filter UI patterns
- Proper touch target sizing for filter controls

**Mobile Features**:

- Swipe gestures for destination card interaction
- Mobile-optimized search with keyboard handling
- Collapsible filters for small screen sizes
- Mobile-specific pagination controls

### Integration Points

**Homepage Integration**: Connect with existing homepage destination cards
**Navigation Integration**: Proper breadcrumb and header navigation
**Destination Pages Integration**: Seamless linking to individual destination pages
**Blog Integration**: Links to destination-specific blog content

### Error Handling and Edge Cases

**Error Scenarios**: [Source: architecture/coding-standards.md#Error Handling Standards]

- Database unavailability fallback with static destination list
- Search functionality failure with graceful degradation
- Missing destination data handling
- Network connectivity issues for search functionality

**Empty States**:

- No search results found
- No destinations available for selected passport
- Loading states for search and filtering
- Error states with retry functionality

## Testing

**Location**: Tests in `__tests__/` directories alongside components and services [Source: architecture/source-tree.md#Testing Organization]

**Framework**: Jest with React Testing Library for component testing [Source: architecture/coding-standards.md#Testing Standards]

**Coverage Focus**: Test service layer functions, search functionality, filtering logic, and component interactions

**Specific Testing Requirements**:

- Test destinations listing with various locale and filtering combinations
- Test search functionality with autocomplete and result filtering
- Test passport-based filtering with visa eligibility data
- Test mobile responsiveness and touch interactions
- Test error handling and empty state scenarios
- Test integration with homepage destination cards
- Test performance with large destination datasets

## Change Log

| Date     | Version | Description                                                                  | Author       |
| -------- | ------- | ---------------------------------------------------------------------------- | ------------ |
| Sep 2024 | 1.0     | Initial story creation for all destinations listing and search functionality | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent review_

# Story 1.1: Implement Core Database Services and Visa Eligibility System

## Status

Draft

## Story

**As a** platform administrator,
**I want** comprehensive database services for countries, visa types, and eligibility relationships,
**so that** the platform can dynamically serve visa information based on passport-destination combinations.

## Acceptance Criteria

1. Complete implementation of existing Drizzle schema with proper relationships
2. Service layer provides visa eligibility checking by passport and destination
3. Multilingual content support for country names, visa descriptions in 8 languages
4. Database seeding with initial country and visa type data for top 25 destinations
5. Error handling for database queries with Sentry integration

## Tasks / Subtasks

- [ ] Complete database schema implementation (AC: 1)
  - [ ] Review existing schema files in `/src/lib/db/schema/` for completeness
  - [ ] Ensure proper relationships between countries, visaTypes, and visaEligibility tables
  - [ ] Verify all required indexes are properly defined for performance
  - [ ] Add any missing schema definitions based on PRD requirements

- [ ] Implement visa eligibility service functions (AC: 2, 3)
  - [ ] Create `checkVisaEligibility` function in `/src/lib/services/visa-service.ts`
  - [ ] Implement passport-destination-visa combination logic using visa eligibility table
  - [ ] Add multilingual support for visa type names and descriptions across 8 languages
  - [ ] Ensure service functions return properly typed interfaces with localization

- [ ] Enhance existing service layer with missing functionality (AC: 2, 3, 5)
  - [ ] Extend country-service.ts with destination-specific data fetching capabilities
  - [ ] Implement comprehensive error handling with graceful fallbacks in all service functions
  - [ ] Add Sentry integration for database query failures and service errors
  - [ ] Ensure database availability checking works correctly before all operations

- [ ] Create database migration and seeding system (AC: 4)
  - [ ] Generate initial database migration using `pnpm db:generate`
  - [ ] Create data seeding script for top 25 destinations with visa types
  - [ ] Include multilingual content for countries and visa types in all 8 supported languages
  - [ ] Test migration and seeding in local development environment

- [ ] Implement comprehensive testing for service layer (AC: 1, 2, 5)
  - [ ] Create unit tests for visa eligibility checking logic
  - [ ] Test multilingual content retrieval for all supported languages
  - [ ] Test error handling scenarios including database unavailability
  - [ ] Create integration tests for database operations and service layer interactions
  - [ ] Validate that existing homepage functionality remains unaffected

## Dev Notes

### Existing Database Schema Analysis

**Schema Location**: `/src/lib/db/schema/` [Source: architecture/source-tree.md#Business Logic]

**Current Schema Implementation**:

- **countries table**: Already implemented with id, code (ISO 3166-1 alpha-3), continent, region, heroImage, isActive, timestamps, soft delete
- **countriesI18n table**: Implemented for multilingual support with countryId, locale, name, name_long, about fields
- **visaTypes table**: Complete implementation with destinationId, type, duration, processingTime, fee, requirements, documents, etc.
- **visaTypesI18n table**: Multilingual support for visa type names and descriptions
- **visaEligibility table**: Relationship table with destinationId, passportId, visaTypeId, eligibilityStatus, maxStayDays
- **visaEligibilityI18n table**: Multilingual notes for eligibility rules

[Source: src/lib/db/schema/countries.ts, visa-types.ts, visa-eligibility.ts]

### Service Layer Architecture

**Service Location**: `/src/lib/services/` [Source: architecture/source-tree.md#Service Layer Patterns]

**Existing Service Functions**:

- **country-service.ts**: Contains getCountryNames, getAllCountries, getCountryByCode, searchCountries, getPopularDestinations, getCountriesByCodes
- **visa-service.ts**: Contains getRandomVisaTypes, getVisaTypesByDestination, getAllVisaTypes, getVisaTypeById
- **Database Connection**: Uses `getDbAsync()` and `isDatabaseAvailableAsync()` patterns with graceful fallbacks

[Source: src/lib/services/country-service.ts, visa-service.ts]

**Missing Service Functions Needed**:

- Visa eligibility checking function combining passport, destination, and visa type data
- Enhanced error handling with Sentry integration
- Comprehensive multilingual support validation

### Database Technology Stack

**Database System**: Cloudflare D1 (SQLite) with Drizzle ORM 0.44.5 [Source: architecture/tech-stack.md#Backend & Database]

**Key Features**:

- Type-safe SQL query building with full TypeScript integration
- Prepared statements for performance optimization
- Migration system via Drizzle Kit for schema versioning
- Relationship modeling between countries, visa types, and eligibility rules

**Database Commands**: [Source: architecture/tech-stack.md#Database Management]

```bash
pnpm db:generate        # Generate migrations
pnpm db:migrate         # Run migrations
pnpm db:studio          # Open Drizzle Studio
```

### Error Handling Standards

**Error Handling Pattern**: [Source: architecture/coding-standards.md#Error Handling Standards]

- Graceful degradation with fallbacks for database unavailability
- Consistent logging patterns with appropriate levels
- Database availability checking before all operations using `isDatabaseAvailableAsync()`
- Return empty arrays/null on failures rather than throwing exceptions

**Sentry Integration**: [Source: architecture/tech-stack.md#Analytics & Monitoring]

- Application error tracking and performance monitoring
- Integration with existing error tracking infrastructure
- Structured logging with appropriate log levels

### Internationalization Requirements

**i18next Integration**: 8 language support (EN, ES, AR, PT, RU, DE, FR, IT) [Source: architecture/tech-stack.md#Internationalization]

- Namespace organization with structured translation files
- Dynamic language loading with proper fallback strategies
- Support for complex plural forms and variable interpolation

**Database I18n Tables**:

- All content tables have corresponding i18n tables with locale-specific content
- Unique constraints on entity-locale combinations
- Proper foreign key relationships for data integrity

### File Structure and Naming Conventions

**Service File Location**: `/src/lib/services/` with kebab-case naming [Source: architecture/source-tree.md#File Naming Conventions]
**Schema File Location**: `/src/lib/db/schema/` with separate files per entity
**Test File Location**: `__tests__/` directories alongside source code
**Import Patterns**: Use absolute imports with TypeScript path mapping (@/lib/services)

[Source: architecture/source-tree.md#Import/Export Patterns]

### Testing Standards

**Testing Framework**: Jest 30.1.3 with @testing-library/react 16.3.0 [Source: architecture/tech-stack.md#Testing Framework]

**Test Requirements**: [Source: architecture/coding-standards.md#Testing Standards]

- Focus on business logic in service layer, not UI components
- Use Arrange-Act-Assert pattern for test structure
- Mock external dependencies appropriately
- Test database service functions, error handling, and data transformations
- Co-locate tests with source code in `__tests__/` directories

**Coverage Requirements**:

- Database service layer testing with proper mocking
- API route testing for new endpoints
- Integration testing for service layer interactions
- Error scenario testing including database failures

### TypeScript Standards

**Type Safety Requirements**: [Source: architecture/coding-standards.md#Language Standards]

- Strict mode enabled with explicit types for all function parameters
- Use interfaces over types for object definitions
- Avoid `any` type, use specific types or `unknown`
- Proper type definitions for all database entities and service returns

**Database Type Integration**:

- Use Drizzle ORM's `$inferSelect` and `$inferInsert` for type generation
- Existing type definitions: Country, NewCountry, CountryI18n, VisaType, VisaEligibility

## Testing

**Location**: Tests should be created in `__tests__` directories alongside service files [Source: architecture/source-tree.md#Testing Organization]

**Framework**: Use Jest with proper configuration for database testing [Source: architecture/coding-standards.md#Testing Standards]

**Coverage Focus**: Test business logic in service layer, database operations, and error handling scenarios

**Specific Testing Requirements**:

- Test visa eligibility checking with various passport-destination combinations
- Test multilingual content retrieval with fallback strategies
- Test database unavailability graceful degradation
- Test service layer error handling and Sentry integration
- Validate database seeding and migration procedures

## Change Log

| Date     | Version | Description                                                                   | Author       |
| -------- | ------- | ----------------------------------------------------------------------------- | ------------ |
| Sep 2024 | 1.0     | Initial story creation for core database services and visa eligibility system | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent review_

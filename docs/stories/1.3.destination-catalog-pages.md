# Story 1.2: Destination Catalog Pages

## Status

Draft

## Story

**As a** traveler researching visa requirements,
**I want** destination-specific pages showing all available visa options with clear eligibility information,
**so that** I can understand visa requirements before booking travel and make informed decisions about my destination.

## Dependencies

- **Story 1.1**: Database Service Layer Foundation - REQUIRED
  - Depends on `getDestinationDetails()` and `getDestinationWithVisaTypes()` functions
  - Requires visa eligibility checking service functions
  - Needs error handling and performance optimization from service layer

## Acceptance Criteria

1. Destination pages at `/[locale]/d/[destination]` display comprehensive visa information for the specified destination
2. Visa options show fees, processing times, validity periods, entry restrictions, and required documents
3. All destination content supports multilingual display across 8 supported languages (en, ar, es, pt, ru, de, fr, it)
4. Pages follow existing responsive design patterns and maintain homepage design consistency
5. Proper SEO metadata and structured data (JSON-LD) implemented for search engine optimization
6. Pages integrate seamlessly with existing header/footer navigation components
7. RTL language support maintains identical functionality for Arabic users
8. Error handling gracefully manages missing destination data or database unavailability
9. Pages load with proper loading states and error boundaries following Next.js App Router patterns
10. Blog post integration showing related travel articles for each destination

## Tasks / Subtasks

- [ ] Create destination page route structure (AC: 1)
  - [ ] Create `/src/app/[locale]/d/[destination]/page.tsx` route file
  - [ ] Implement dynamic route parameter handling for destination codes
  - [ ] Add proper TypeScript interfaces for page props and params
  - [ ] Implement loading.tsx and error.tsx for the route

- [ ] Implement destination data fetching and services (AC: 1, 2)
  - [ ] Extend country-service.ts to include destination-specific data fetching
  - [ ] Create getDestinationDetails function with visa type relationships
  - [ ] Implement visa eligibility checking logic in visa-service.ts
  - [ ] Add proper error handling and fallback strategies for service calls

- [ ] Build destination page UI components (AC: 2, 4, 6)
  - [ ] Create DestinationHero component with country information
  - [ ] Build VisaOptionsGrid component to display available visa types
  - [ ] Create VisaTypeDetailCard component with fees, processing times, validity
  - [ ] Implement RequiredDocuments component for visa requirements
  - [ ] Add destination-specific breadcrumb navigation

- [ ] Implement multilingual content support (AC: 3, 7)
  - [ ] Add destination page translations for all 8 supported languages
  - [ ] Implement RTL-aware layout adjustments for Arabic
  - [ ] Ensure all text content uses translation functions (useTranslations)
  - [ ] Test language switching functionality across destination pages

- [ ] Add SEO optimization and metadata (AC: 5)
  - [ ] Implement generateMetadata function for dynamic meta tags
  - [ ] Add structured data (JSON-LD) for destination and visa information
  - [ ] Configure canonical URLs for proper SEO indexing
  - [ ] Ensure proper Open Graph tags for social sharing

- [ ] Integration testing and validation (AC: 6, 8, 9)
  - [ ] Verify existing header/footer navigation works correctly
  - [ ] Test database error scenarios with graceful fallbacks
  - [ ] Validate responsive design across device sizes
  - [ ] Confirm RTL layout functionality for Arabic language
  - [ ] Test all 8 language variations for proper display

## Dev Notes

### Relevant Source Tree Information

**Route Location**: `/src/app/[locale]/d/[destination]/page.tsx`  
**Service Layer**: Extend `/src/lib/services/country-service.ts` and `/src/lib/services/visa-service.ts`  
**Components**: Create in `/src/components/ui/` following existing patterns  
**Internationalization**: Use existing i18n setup with `useTranslations` hook

### Key Architecture Patterns to Follow

**Server Components**: Use Server Components by default for data fetching and SEO  
**Error Boundaries**: Implement proper error.tsx and loading.tsx files  
**Database Integration**: Use existing Drizzle ORM patterns with graceful fallbacks  
**Styling**: Follow Tailwind CSS patterns with RTL support using directional utilities  
**Type Safety**: Use strict TypeScript with explicit interfaces for all props and data

### Existing Integration Points

**Database Schema**: Integrate with existing countries, visaTypes, and visaEligibility tables  
**UI Components**: Extend existing DestinationCard and VisaTypeCard patterns  
**Layout System**: Use existing Header and Footer components  
**Translation System**: Leverage existing i18next setup with locale-based routing

### Performance Considerations

**Static Generation**: Use generateStaticParams for popular destinations when possible  
**Database Queries**: Implement proper query optimization with database availability checks  
**Image Optimization**: Use Next.js Image component for country/destination images  
**Caching**: Implement appropriate caching strategies for destination data

### Testing

**Location**: Tests should be created in `__tests__` directories alongside components  
**Framework**: Use Jest with @testing-library/react for component testing  
**Coverage**: Focus on business logic in service layer, not UI appearance  
**Standards**: Test database service functions, error handling, and data transformations  
**Integration**: Test API routes and database operations with proper mocking

**Specific Testing Requirements**:

- Test destination data fetching with various database states
- Test multilingual content rendering and translation integration
- Test error scenarios including missing destinations and database failures
- Test RTL layout adjustments for Arabic language support
- Test SEO metadata generation and structured data output

### Arabic RTL Testing Scenarios

**Critical RTL Layout Tests** (AC: 7 - RTL language support):

1. **Page Layout Direction**:
   - ✓ Entire page direction changes to `dir="rtl"` when Arabic locale selected
   - ✓ Navigation breadcrumbs display right-to-left with proper arrow direction (← instead of →)
   - ✓ Language switcher maintains functionality and positioning in RTL mode

2. **Component RTL Behavior**:
   - ✓ DestinationHero component: Text aligns right, flag image positions on right side
   - ✓ VisaOptionsGrid: Cards flow right-to-left, maintaining proper spacing
   - ✓ VisaTypeDetailCard: Icon positioning mirrors to left side, text right-aligned
   - ✓ RequiredDocuments: List items display with proper RTL bullet/numbering

3. **Content RTL Validation**:
   - ✓ Visa fees display with Arabic currency format and right alignment
   - ✓ Processing times (e.g., "3-5 أيام عمل") render correctly in Arabic numerals
   - ✓ Validity periods maintain proper Arabic date formatting
   - ✓ Entry restrictions text flows naturally in Arabic script

4. **Interactive Elements RTL**:
   - ✓ Dropdown menus for passport selection open in correct RTL direction
   - ✓ Form inputs maintain proper RTL text entry and placeholder alignment
   - ✓ Button icons (chevrons, arrows) flip to appropriate RTL orientation

5. **Cross-Language Consistency**:
   - ✓ Switching from Arabic to English maintains same functionality
   - ✓ Page content updates correctly without layout breaks
   - ✓ URL structure remains consistent across language switches

### Integration Testing Strategy

**Service Layer Integration Tests** (AC: 1, 2, 8):

1. **Database Integration Tests**:

   ```typescript
   describe("Destination Data Integration", () => {
     test("getDestinationDetails handles database unavailability gracefully");
     test("visa eligibility calculation with various country combinations");
     test("multilingual content retrieval with fallback strategies");
     test("database connection timeout and retry logic");
   });
   ```

2. **Service Function Integration**:

   ```typescript
   describe("Country Service Extensions", () => {
     test("getDestinationDetails returns complete visa relationships");
     test("country code validation and normalization");
     test("destination not found error handling");
   });

   describe("Visa Service Integration", () => {
     test("visa eligibility checking with passport-destination pairs");
     test("visa type filtering based on eligibility rules");
     test("required documents retrieval by visa type");
   });
   ```

3. **Translation Integration Tests**:

   ```typescript
   describe("Multilingual Content Integration", () => {
     test("destination content loads in all 8 supported languages");
     test("translation key resolution for destination-specific content");
     test("fallback language when destination content unavailable");
     test("RTL layout rendering for Arabic content");
   });
   ```

4. **Error Boundary Integration**:

   ```typescript
   describe("Error Handling Integration", () => {
     test("missing destination graceful degradation");
     test("database connection failure fallback");
     test("invalid destination code handling");
     test("SEO metadata generation during errors");
   });
   ```

5. **Performance Integration Tests**:
   ```typescript
   describe("Performance Integration", () => {
     test("destination page load time under 3 seconds");
     test("database query optimization with large datasets");
     test("image loading and optimization integration");
     test("caching strategy effectiveness");
   });
   ```

**Integration Test Data Requirements**:

- **Test Database**: Seeded with 25+ countries and visa types
- **Mock Translations**: Complete translation sets for Arabic, English, Spanish
- **Error Scenarios**: Database unavailable, network timeout, missing data
- **Performance Baselines**: Load time targets, query optimization metrics

## Change Log

| Date     | Version | Description                                                                       | Author        |
| -------- | ------- | --------------------------------------------------------------------------------- | ------------- |
| Sep 2024 | 1.0     | Initial story creation for destination catalog pages                              | Product Owner |
| Sep 2024 | 1.1     | Added comprehensive Arabic RTL testing scenarios and integration testing strategy | Product Owner |
| Sep 2024 | 1.2     | Moved from Story 1.2 to 1.4 in resequenced epic for content-first approach        | Scrum Master  |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent review_

## Epic Context

This story is part of **Epic 1: Complete Destination-Driven Visa Catalog System** and implements the core destination pages functionality:

**Position in Epic**: Second story in critical path after Story 1.1 (Database Service Layer Foundation)

**Enables Future Stories**:

- **Story 1.3**: Passport-Specific Eligibility Pages (extends destination page patterns)
- **Story 1.4**: Visa-Specific Information Pages (uses destination page components)
- **Story 1.5**: Dynamic Homepage Integration (uses destination listing functions)

**Epic Integration Points**:

- Uses service layer functions implemented in Story 1.1
- Provides UI component patterns for Stories 1.3 and 1.4
- Establishes SEO and multilingual patterns for Story 1.6

**Risk Mitigation**: Addresses multiple critical risks identified in risk profile:

- TECH-006 (Translation management complexity) - Implements multilingual content patterns
- DATA-004 (RTL layout breaking) - Establishes Arabic RTL support patterns
- BUS-007 (SEO impact) - Implements structured data and SEO optimization

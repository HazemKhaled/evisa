# Story 1.3: Passport-Specific Eligibility Pages

## Status

Approved

## Story

**As a** traveler with a specific passport country,
**I want** personalized destination pages showing my visa eligibility and available options,
**so that** I can quickly understand which visas I can apply for and which are not available to my nationality.

## Dependencies

- **Story 1.1**: Database Service Layer Foundation - REQUIRED
  - Depends on `checkVisaEligibility()` and `getEligibleVisaTypes()` functions
  - Requires multilingual visa content retrieval functions
- **Story 1.2**: Destination Catalog Pages - REQUIRED
  - Extends destination page UI patterns and components
  - Uses established multilingual and RTL support patterns

## Acceptance Criteria

1. Passport-specific pages at `/[locale]/d/[destination]/p/[passport]` display personalized visa options based on passport country
2. Available visa options are prominently displayed with clear application guidance and fees
3. Unavailable visa options are clearly marked as ineligible with explanatory text for the specific passport country
4. Visa eligibility determination uses accurate passport-destination-visa relationships from the database
5. All passport-specific content supports multilingual display across 8 supported languages with passport country names localized
6. Pages maintain consistent design with destination catalog pages while highlighting eligibility status
7. SEO optimization includes passport-specific meta tags and structured data for search discoverability
8. Error handling manages invalid passport codes, missing destinations, and database unavailability gracefully
9. Pages load efficiently with proper caching of eligibility determinations for frequently accessed passport-destination combinations
10. RTL language support maintains identical functionality and proper layout for Arabic users with passport-specific content

## Tasks / Subtasks

- [ ] Create passport-specific route structure (AC: 1, 8)
  - [ ] Create `/src/app/[locale]/d/[destination]/p/[passport]/page.tsx` route file
  - [ ] Implement dynamic route parameter handling for both destination and passport codes
  - [ ] Add proper TypeScript interfaces for passport-specific page props and params
  - [ ] Implement loading.tsx and error.tsx for passport-specific routes
  - [ ] Add passport code validation and normalization logic

- [ ] Implement passport eligibility data fetching (AC: 1, 4, 9)
  - [ ] Integrate with Story 1.1 service functions for visa eligibility checking
  - [ ] Create `getPassportEligibilityForDestination()` service function calls
  - [ ] Implement caching strategy for frequently accessed passport-destination combinations
  - [ ] Add proper error handling for invalid passport codes and missing data
  - [ ] Optimize query performance for eligibility checking operations

- [ ] Build passport-specific UI components (AC: 2, 3, 6)
  - [ ] Create `EligibleVisaCard` component highlighting available options with prominent styling
  - [ ] Build `IneligibleVisaCard` component clearly marking unavailable options with explanatory text
  - [ ] Implement `PassportHeader` component showing selected passport country with flag and name
  - [ ] Create `EligibilityLegend` component explaining available vs unavailable visa status
  - [ ] Add passport selection/change functionality for exploring different passport options

- [ ] Implement multilingual passport content (AC: 5, 10)
  - [ ] Add passport-specific translations for all 8 supported languages including passport country names
  - [ ] Implement RTL-aware layout adjustments for Arabic with passport-specific content
  - [ ] Ensure eligibility explanations are properly translated and culturally appropriate
  - [ ] Add language switching functionality maintaining passport and destination context
  - [ ] Test Arabic RTL layout with passport country names and eligibility text

- [ ] Add passport-specific SEO optimization (AC: 7)
  - [ ] Implement generateMetadata function for passport-destination specific meta tags
  - [ ] Add structured data (JSON-LD) for passport eligibility and visa options
  - [ ] Configure canonical URLs for passport-specific pages
  - [ ] Ensure proper Open Graph tags for passport-destination specific social sharing
  - [ ] Implement breadcrumb navigation including passport context

- [ ] Integration testing and performance validation (AC: 8, 9)
  - [ ] Test invalid passport code handling with appropriate error messages
  - [ ] Validate database error scenarios with graceful fallbacks to general destination pages
  - [ ] Test caching effectiveness for frequently accessed passport-destination combinations
  - [ ] Verify responsive design across device sizes with passport-specific content
  - [ ] Test performance under concurrent passport eligibility checking requests

- [ ] Cross-language and accessibility testing (AC: 5, 10)
  - [ ] Test all 8 language variations with passport-specific content
  - [ ] Validate RTL layout functionality for Arabic users with passport eligibility information
  - [ ] Test language switching maintaining both passport and destination context
  - [ ] Verify accessibility compliance for eligibility status indicators
  - [ ] Test color contrast and visual indicators for available vs unavailable visa options

## Dev Notes

### Relevant Source Tree Information

**Route Location**: `/src/app/[locale]/d/[destination]/p/[passport]/page.tsx`  
**Service Layer**: Utilize Story 1.1 functions in `/src/lib/services/visa-service.ts` for eligibility checking  
**Components**: Create in `/src/components/ui/` extending patterns from Story 1.2  
**Internationalization**: Extend existing i18n setup with passport-specific translations

### Key Architecture Patterns to Follow

**Server Components**: Use Server Components by default for eligibility data fetching and SEO optimization  
**Component Reuse**: Extend VisaTypeCard patterns from Story 1.2 with eligibility status variants  
**Caching Strategy**: Implement appropriate caching for eligibility determinations to improve performance  
**Error Boundaries**: Implement proper error.tsx and loading.tsx files with passport context  
**Type Safety**: Use strict TypeScript with explicit interfaces for passport eligibility data

### Database Integration Requirements

**Eligibility Logic**: Use visaEligibility table relationships to determine passport-destination-visa availability  
**Query Optimization**: Efficient queries for passport eligibility checking with proper indexing  
**Data Validation**: Validate passport codes against countries table and normalize input format  
**Multilingual Content**: Retrieve passport country names and visa descriptions in appropriate languages

### UI/UX Design Patterns

**Visual Hierarchy**: Clear distinction between available (prominent) and unavailable (subdued) visa options  
**Status Indicators**: Consistent iconography and color coding for visa eligibility status  
**Explanatory Content**: Clear explanations for why specific visas are unavailable to certain passport holders  
**Responsive Design**: Maintain destination page design consistency while accommodating eligibility status information

### Performance Considerations

**Caching Strategy**: Cache eligibility determinations for popular passport-destination combinations  
**Query Optimization**: Efficient database queries for eligibility checking operations  
**Static Generation**: Consider static generation for popular passport-destination combinations  
**Loading States**: Implement proper loading states during eligibility calculation

### SEO and Discoverability

**URL Structure**: Clean URL pattern `/d/[destination]/p/[passport]` for search engine indexing  
**Meta Tags**: Passport-specific meta descriptions and titles for search results  
**Structured Data**: JSON-LD schema for passport eligibility and visa options  
**Canonical URLs**: Proper canonicalization for passport-destination specific pages

### Testing Requirements

**Eligibility Testing**: Test all passport-destination combinations with known eligibility data  
**Edge Cases**: Invalid passport codes, missing destinations, database unavailability scenarios  
**Performance Testing**: Concurrent eligibility checking requests and caching effectiveness  
**Multilingual Testing**: All 8 languages with passport-specific content and RTL functionality  
**Accessibility Testing**: Color contrast, screen reader compatibility for eligibility indicators

### Integration Points

**Story 1.1 Services**: Direct integration with eligibility checking functions from database service layer  
**Story 1.2 Components**: Extend destination page UI patterns with eligibility status variants  
**Existing Navigation**: Integrate with existing header/footer and breadcrumb navigation systems  
**Translation System**: Leverage existing i18next setup with passport-specific translation keys

### Security Considerations

**Input Validation**: Comprehensive validation of passport codes and destination parameters  
**Data Sanitization**: Ensure all user inputs are properly sanitized before database operations  
**Access Control**: Implement appropriate access patterns for passport eligibility data  
**Error Information**: Avoid exposing sensitive system information in error messages

## Epic Context

This story is part of **Epic 1: Complete Destination-Driven Visa Catalog System** and implements personalized visa eligibility functionality:

**Position in Epic**: Third story in sequence, depends on both Stories 1.1 (service layer) and 1.2 (destination pages)

**Enables Future Stories**:

- **Story 1.5**: Dynamic Homepage Integration (uses passport selection patterns)
- **Story 1.6**: SEO & Sitemaps (includes passport-specific pages in sitemaps)

**Epic Integration Points**:

- Uses eligibility checking functions from Story 1.1
- Extends UI patterns and components from Story 1.2
- Provides passport selection patterns for Story 1.5
- Contributes passport-specific URLs for Story 1.6 sitemaps

**Risk Mitigation**: Addresses multiple risks identified in risk profile:

- DATA-004 (RTL layout breaking) - Implements Arabic RTL with passport-specific content
- PERF-002 (Database query performance) - Implements caching for eligibility determinations
- TECH-006 (Translation management) - Handles complex multilingual passport country content

**Business Value**: Enables personalized user experience showing only relevant visa options, improving conversion potential and user satisfaction by filtering out ineligible visa types.

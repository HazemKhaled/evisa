# Story 1.1: Database Service Layer Foundation

## Status

Approved

## Story

**As a** platform developer implementing destination catalog features,
**I want** complete database service layer functions for destination-visa relationships and eligibility checking,
**so that** all destination catalog stories can rely on robust, tested, and performant data access patterns without implementing database logic themselves.

## Acceptance Criteria

1. Database service layer provides complete destination data retrieval with visa type relationships and eligibility mappings
2. Visa eligibility checking functions determine available visa options based on passport-destination combinations using existing database schema
3. All service functions include comprehensive error handling with graceful fallbacks for database unavailability scenarios
4. Service layer implements query performance optimization to meet <1 second response time requirements (NFR1 compliance)
5. Functions follow existing Drizzle ORM patterns and integrate seamlessly with established service architecture
6. Comprehensive unit tests validate all service functions with database mocking and edge case coverage
7. Integration tests verify actual database operations work correctly with existing schema and seed data
8. Service functions support multilingual content retrieval for all 8 supported languages with fallback strategies
9. Input validation prevents SQL injection and ensures data integrity for all destination and country code parameters

## Tasks / Subtasks

- [ ] Implement destination data retrieval functions (AC: 1, 5)
  - [ ] Extend `/src/lib/services/country-service.ts` with `getDestinationDetails()` function
  - [ ] Add `getDestinationWithVisaTypes()` function to retrieve destination with all available visa relationships
  - [ ] Create `getDestinationsListWithMetadata()` for destination catalog listing pages
  - [ ] Implement proper TypeScript interfaces for destination data structures
  - [ ] Add comprehensive JSDoc documentation for all new functions

- [ ] Implement visa eligibility checking service (AC: 2, 8)
  - [ ] Extend `/src/lib/services/visa-service.ts` with `checkVisaEligibility()` function
  - [ ] Add `getEligibleVisaTypes()` function for passport-destination combinations
  - [ ] Create `getVisaRequirements()` function to retrieve specific visa documentation needs
  - [ ] Implement multilingual visa content retrieval with language fallback logic
  - [ ] Add visa type filtering and sorting based on eligibility status

- [ ] Implement error handling and resilience patterns (AC: 3, 9)
  - [ ] Add database connection health checking with timeout handling
  - [ ] Implement graceful degradation strategies for service unavailability
  - [ ] Create fallback data structures for offline/error scenarios
  - [ ] Add comprehensive input validation and sanitization for all parameters
  - [ ] Implement proper error logging with Sentry integration preparation

- [ ] Optimize database query performance (AC: 4)
  - [ ] Add database indexes for frequently queried destination-visa relationships
  - [ ] Implement query result caching using appropriate caching strategy
  - [ ] Optimize complex JOIN operations for visa eligibility checking
  - [ ] Add query performance monitoring and logging
  - [ ] Ensure all queries execute under 1 second performance requirement

- [ ] Create comprehensive unit test suite (AC: 6)
  - [ ] Unit tests for `getDestinationDetails()` with various input scenarios
  - [ ] Unit tests for visa eligibility checking with edge cases (invalid countries, missing visas)
  - [ ] Mock database operations to test error handling and fallback scenarios
  - [ ] Test multilingual content retrieval and fallback mechanisms
  - [ ] Validate input sanitization prevents SQL injection attempts

- [ ] Implement integration tests (AC: 7)
  - [ ] Integration tests with actual database using test seed data
  - [ ] Test destination-visa relationship queries with existing schema
  - [ ] Validate database performance under concurrent request scenarios
  - [ ] Test database connection failure and recovery scenarios
  - [ ] Verify compatibility with existing database migration and seed scripts

- [ ] Service layer integration and documentation (AC: 5)
  - [ ] Ensure new functions follow existing service patterns and conventions
  - [ ] Update service layer exports and TypeScript declarations
  - [ ] Add comprehensive documentation for API contracts and expected usage
  - [ ] Verify integration with existing error boundaries and logging systems
  - [ ] Create usage examples and integration guidelines for other developers

## Dev Notes

### Relevant Source Tree Information

**Service Layer Extension**: Extend existing `/src/lib/services/country-service.ts` and `/src/lib/services/visa-service.ts`  
[Source: docs/architecture/source-tree.md#Services]

**Database Integration**: Use existing Drizzle ORM setup with `/src/lib/db/schema.ts` for countries, visaTypes, and visaEligibility tables  
[Source: docs/architecture/tech-stack.md#Database]

**Testing Location**: Create tests in `/src/lib/services/__tests__/` following existing Jest patterns  
[Source: docs/architecture/coding-standards.md#Testing]

### Key Architecture Patterns to Follow

**Service Layer Patterns**: Follow existing patterns in country-service.ts for function structure, error handling, and TypeScript types  
[Source: docs/architecture/coding-standards.md#Service Layer]

**Database Operations**: Use Drizzle ORM patterns with proper query building and transaction handling  
[Source: docs/architecture/tech-stack.md#Database]

**Error Handling**: Implement consistent error handling patterns with proper logging and user-friendly error messages  
[Source: docs/architecture/coding-standards.md#Error Handling]

### Database Schema Integration

**Key Tables**: Integration with existing schema tables:

- `countries` - Country data with codes and multilingual names
- `visaTypes` - Available visa types with fees, processing times, validity
- `visaEligibility` - Many-to-many relationships between destinations, passports, and visa types
  [Source: Existing database schema in `/src/lib/db/schema.ts`]

**Query Patterns**: Complex JOIN operations required for destination-visa-eligibility relationships
**Performance Considerations**: Proper indexing needed for destination and country code lookups

### Multilingual Content Support

**Language Handling**: Support all 8 languages (en, ar, es, pt, ru, de, fr, it) with proper fallback to English  
[Source: docs/architecture/tech-stack.md#Internationalization]

**Content Structure**: Handle multilingual destination names, visa descriptions, and requirement text  
**RTL Support**: Ensure Arabic language content is properly handled in service layer responses

### Testing Requirements

**Unit Testing**: Focus on business logic, data transformation, and error handling scenarios  
[Source: docs/architecture/coding-standards.md#Testing]

**Integration Testing**: Database operations, query performance, and multi-language content retrieval  
**Performance Testing**: Validate < 1 second query response times under load  
**Security Testing**: SQL injection prevention and input validation

### Performance Optimization Strategy

**Query Optimization**: Implement proper indexing and query structure for complex destination-visa relationships  
**Caching Strategy**: Consider implementing query result caching for frequently accessed destination data  
**Connection Pooling**: Ensure efficient database connection management with existing Drizzle setup  
**Monitoring**: Add performance metrics and monitoring for query execution times

### Integration Points

**Existing Services**: Extend current country-service.ts patterns without breaking existing functionality  
**Database Schema**: Work with existing Drizzle schema without requiring schema changes  
**Error Boundaries**: Integrate with existing error handling and logging infrastructure  
**Type Safety**: Maintain strict TypeScript compliance with existing patterns and interfaces

### Security Considerations

**Input Validation**: Comprehensive validation of destination codes, country codes, and passport parameters  
**SQL Injection Prevention**: Use parameterized queries and proper Drizzle ORM patterns  
**Data Sanitization**: Ensure all user inputs are properly sanitized before database operations  
**Access Control**: Implement appropriate access patterns for sensitive visa eligibility data

### Testing

**Location**: Tests should be created in `/src/lib/services/__tests__/` following existing Jest patterns  
**Framework**: Use Jest with appropriate mocking for database operations  
**Coverage**: Focus on business logic, error scenarios, and edge cases rather than trivial operations  
**Standards**: Follow existing testing patterns with proper setup, execution, and teardown

**Specific Testing Requirements**:

- Test destination data retrieval with various country codes and invalid inputs
- Test visa eligibility checking with all passport-destination combinations
- Test error handling scenarios including database unavailability and timeout conditions
- Test multilingual content retrieval and fallback mechanisms for all 8 supported languages
- Test query performance under concurrent access and large dataset scenarios
- Test input validation and SQL injection prevention measures

**Integration Testing Requirements**:

- Test actual database operations with test seed data and schema validation
- Test query performance meets < 1 second requirement with realistic data volumes
- Test database connection failure scenarios and recovery mechanisms
- Test compatibility with existing database migrations and seed scripts
- Test concurrent access patterns and connection pool management

This story establishes the critical foundation that all other destination catalog stories depend on. The service layer must be robust, performant, and thoroughly tested before any UI implementation can proceed safely.

## Epic Context

This story is part of **Epic 1: Complete Destination-Driven Visa Catalog System** and serves as the foundational dependency for all other stories:

- **Story 1.2**: Destination Catalog Pages (depends on destination data retrieval functions)
- **Story 1.3**: Passport-Specific Eligibility Pages (depends on visa eligibility checking functions)
- **Story 1.4**: Visa-Specific Information Pages (depends on visa detail retrieval functions)
- **Story 1.5**: Dynamic Homepage Integration (depends on destination listing functions)
- **Story 1.6**: SEO & Sitemaps (depends on all destination and visa data functions)

**Critical Path Impact**: This story blocks all other Epic 1 stories. No destination catalog functionality can be implemented without these service layer foundations.

**Risk Mitigation**: Addresses TECH-001 (Missing database service layer integration) identified as the highest risk in the risk profile with score 9/9 (Critical).
